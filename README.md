# kaggle-Child-Mind-Institute_Detect-Sleep-States

![Title](https://github.com/fmoch/kaggle-Child-Mind-Institute_Detect-Sleep-States/assets/116940479/1909fb16-772b-4f0b-8afd-e7f2c9e289e5)

Child_Mind_Institute-Detect_Sleep_Statesコンペのリポジトリ

- result
  - public: ●●
    - rank: ●●/●●
  - private: ●●
    - rank: ●●/●●

## Overview

 　あなたの研究は、研究者の睡眠モニタリングのための加速度計データの分析能力を向上させ、睡眠に関する大規模な研究を実施することを可能にする。最終的に、このコンペティションの研究は、睡眠の重要性に関する認識と指針を改善する可能性がある。環境要因が睡眠、気分、行動にどのような影響を与えるかについての貴重な洞察は、それぞれの子供のユニークなニーズに合わせた個別化介入や支援システムの開発に役立つ。

### 競技の目的

 このコンペティションの目標は、入眠と覚醒を検知することです。手首に装着した加速度計のデータで学習させたモデルを開発し、人の睡眠状態を判定する。

 あなたの研究により、研究者はさまざまな集団や状況において、より信頼性の高い大規模な睡眠研究を実施できるようになります。そのような研究の結果、睡眠に関するさらに多くの情報が得られる可能性があります。

 また、このコンペティションの成功は、子どもや若者、特に気分や行動に困難を抱える子どもたちにとっても重要な意味を持つ。睡眠は、あらゆる年齢層、特に子どもたちの気分、感情、行動を調整する上で極めて重要である。手首に装着した加速度計のデータから睡眠と覚醒の時間を正確に検出することで、研究者は睡眠パターンについてより深い理解を得ることができ、子どもの睡眠障害についてよりよく理解することができる。

### コンテキスト

 毎晩の "Zzzs "は全身の健康にとって極めて重要である。睡眠は発育から認知機能まで、あらゆることに影響する。それでも、睡眠に関する研究は、正確な注釈とともに自然主義的なデータの取得ができないため、困難であることが判明している。もしデータサイエンスが、睡眠モニタリングのために手首に装着する加速度計のデータを研究者がよりよく分析できるようになれば、睡眠の専門家はより簡単に睡眠に関する大規模な研究を実施できるようになり、睡眠の重要性と機能についての理解が深まるだろう。

睡眠データに注釈を付けるための現在のアプローチには、入眠を検出するためのゴールドスタンダードである睡眠記録がある。しかし、多くの参加者が確実に使用するのは非現実的であり、ベッドに向かうときと眠りに落ちるとき（または逆に、目が覚めたときとベッドから出るとき）の微妙な違いを捉えることができない。ヒューリスティック・ベースのソフトウェアも、睡眠の窓を特定しようとするソリューションのひとつであるが、これらは、個人によって異なる睡眠の特徴（腕の角度など）を人間が操作したものに依存しており、専門家がデータから視覚的に検出できる睡眠の窓を正確に要約することはできない。睡眠データを大規模に分析するツールが改善されれば、研究者は睡眠と気分・行動上の困難との関係を探ることができる。この知識は、より的を絞った介入や治療戦略につながる。

コンペティション主催 チャイルド・マインド・インスティテュート（CMI）は、メンタルヘルスや学習障害に悩む子どもたちや家族に必要な支援を提供することで、その生活を一変させている。CMIは、エビデンスに基づく最高水準のケアを提供し、毎年数百万人の家族に教育リソースを提供し、十分なサービスを受けていない地域の教育者を訓練し、明日の画期的な治療法を開発することで、子どものメンタルヘルスにおける独立系非営利団体のリーダーとなっている。

スタブロス・ニアルコス財団（SNF）からの基礎助成金を受けて設立されたチャイルド・マインド研究所のSNF児童青年精神保健グローバル・センターは、子どもの精神保健に関する研究が不十分な分野での世界的な協力を加速させ、文化的に適切なトレーニング、リソース、治療への世界的なアクセスを拡大するために活動している。SNFグローバルセンターの主な目標は、臨床評価と介入におけるイノベーションを拡大することであり、モバイルアプリ、センサー、分析ツールなど、メンタルヘルスのケアと研究を補強する新技術の構築、テスト、導入を含む。

あなたの研究は、研究者の睡眠モニタリングのための加速度計データの分析能力を向上させ、大規模な睡眠研究を実施することを可能にします。最終的に、このコンペティションの研究は、睡眠の重要性をめぐる認識と指針を改善する可能性があります。環境要因が睡眠、気分、行動にどのような影響を与えるかについての貴重な洞察は、子どもたち一人ひとりのユニークなニーズに合わせた個別の介入策や支援システムの開発に役立てることができる。


### 評価

投稿は、`検出されたイベントの平均精度`、`タイムスタンプ誤差許容閾値の平均`、`イベントクラスの平均`で評価されます。

検出された事象は、誤差許容範囲内でGround-Truth *(Ground truth とは、AI モデルの出力の学習やテストに使用される実際のデータを表す用語)* と照合され、曖昧さは信頼性の低い順に解決されます。両イベントクラスとも、誤差許容閾値は分単位で`1、3、5、7.5、10、12.5、15、20、25、30`、またはステップ単位で`12、36、60、90、120、150、180、240、300、360`を使用する。

このメトリックのPythonコードはこちら：イベント検出AP。

#### 詳細説明

評価は3つのステップで進む：

- **割り当て**
  - 予測されたイベントは、実観測イベントとマッチングされます。
- **スコアリング**
  - 予測の各グループは、平均精度を介して、対応する実観測イベントのグループに対してスコアリングされます。
- **削減**
  - 複数のAPスコアが平均化され、1つの総合スコアが生成されます。

##### 割り当て

同じ`イベント x 許容範囲 x series_id` グループ内の予測および実観測データの各セットについて、各実観測データを、許容される許容範囲内で発生する最も信頼性の高い一致しない予測にマッチさせる。

いくつかの実観測データは予測にマッチしないかもしれないし、いくつかの予測は実観測データにマッチしないかもしれない。しかし、それらはまだスコアリングで考慮されます。

##### スコアリング

各 series_id 内のイベントを収集し、各`イベント x トレランス`グループの平均精度スコアを計算します。平均精度スコアは、予測値の信頼スコアしきい値を減少させることで生成される精度-再現曲線の下の面積です。この計算では、しきい値を超えてマッチした予測は TP、マッチしていない予測は FP として`スコア`付けされる。一致しない実観測データはFNとしてスコア付けされる。

##### 削減

最終的なスコアは、上記のAPスコアの平均であり、まず`寛容度の平均`、次に`イベントの平均`となる。

### Submit

series_idで示される各シリーズについて、そのシリーズで発生する各イベントを、タイプと発生したステップ、およびそのイベントの信頼度スコアを与えて予測する。評価指標はさらに、イベントの列挙を持つrow_idを必要とする。
ファイルはヘッダーを含み、以下のフォーマットでなければならない：

```python
行ID,シリーズID,ステップ,イベント,スコア
0,038441c925bb,100,onset,0.0
1,038441c925bb,105,wakeup,0.0
2,03d92c9f6f8a,80,onset,0.5
3,03d92c9f6f8a,110,wakeup,0.5
4,0402a003dae9,90,onset,1.0
5,0402a003dae9,120,wakeup,1.0
...
```

実観測データのアノテーションは、（データ・ページに記載されているように）一定の規則に従って作成されていますが、あなたの投稿ファイルにはそのような制限はないことに注意してください。

#### コード要求

**これはコードコンペティションです**
このコンペティションへの投稿は、Notebooksから行う必要があります。コミット後に "Submit "ボタンが有効になるためには、以下の条件を満たす必要があります：

- CPUノートブック <= 9時間のランタイム
- GPUノートブック <= 9時間のランタイム
- インターネットアクセスが無効
- 訓練済みモデルを含め、自由に一般利用可能な外部データを許可する。
- 提出ファイル名はsubmission.csvとすること。
投稿方法の詳細については、コードコンペティションFAQをご覧ください。また、投稿エラーが発生した場合は、コードデバッグのドキュメントを確認してください。

## Timeline

- **2023年9月5日** - 開始日
- **2023年11月28日** - エントリー締切日
- **2023年11月28日** - チーム合併締切日
- **2023年12月5日** - 最終提出期限

すべての締め切りは、特に断りのない限り、該当日の午後11時59分（UTC）です。大会主催者は、必要と判断した場合、コンテストのスケジュールを更新する権利を有する。

## Data

このデータセットは、手首に装着した加速度計データの約500の複数日の記録から構成され、2つのイベントタイプ、すなわち`睡眠の開始であるオンセット`と、`睡眠の終了であるウェイクアップ`が注釈されている。あなたのタスクは、加速度計シリーズからこれら2つのイベントの発生を検出することです。

睡眠日誌は依然としてゴールド・スタンダードですが、加速度計データを扱う場合、睡眠とは、腕時計を装着している間、活動していない最も長い単一期間を指します。このデータのために、我々はいくつかの具体的な指示で評価者を誘導した：

- 1回の睡眠時間は少なくとも`30分`でなければならない。
- 1回の睡眠は、連続30分を超えない活動によって中断することができる。
- 時計が装着されていると判断されない限り、睡眠時間を検出することはできない。
- 夜間の`最長睡眠時間`のみが記録される。
- 有効な睡眠ウィンドウが特定できない場合、その夜間の入眠イベントも起床イベン トも記録されない。
- 睡眠イベントは日線をまたぐ必要はないため、一定期間内にいくつ発生してもよいという明確なルールはない。しかし、1晩に1つ以上のウィンドウを割り当てるべきではない。例えば、同じ暦日で01h00-06h00と19h00-23h30に睡眠ウィンドウを持つ個人は、連続した夜に割り当てられていても有効である。
- 1つのシリーズに記録される夜の数は、そのシリーズに含まれる24時間の数とほぼ同じである。
- 各シリーズは連続した記録であるが、加速度計を取り外した期間もある。これらの期間は、加速度計の信号の変動が長時間にわたって不審なほど少ない期間として決定される。イベント予測は偽陽性として採点されます。

各データ系列は、一人の実験被験者に対するこの連続的な（複数日／イベント）記録を表しています。

これはコード・コンペティションであり、実際のテスト・セットは隠されていることに注意。この公開バージョンでは、解答のオーサリングに役立つように、正しい形式のサンプルデータをいくつか提供します。完全なテストセットには約200シリーズが含まれています。

### train_series.parquet

トレーニングデータとして使用するシリーズ。各シリーズは、1人の被験者の加速度計データを何日間にもわたって連続記録したもの。
|name|説明|
|---|---|
|series_id | 各加速度センサシリーズの一意な識別子．|
|step | シリーズ内の各オブザベーションのタイムステップ（整数）．|
|timestamp | ISO 8601 フォーマット %Y-%m-%dT%H:%M:%S%z に対応する日時．|
|anglez | GGIR パッケージで計算・記述されているように、z-angle は睡眠検出で一般的に使用される個々の加速度計コンポーネントから導出されるメトリックで、身体の垂直軸に対する腕の角度を指す。|
|ENMO | GGIRパッケージによって計算され、説明されているように、ENMOはすべての加速度計信号のユークリッド正規マイナス1であり、負の値はゼロに丸められます。この空間に加速度の標準的な尺度は存在しないが、これは一般的に計算されるいくつかの特徴の1つである。|

### test_series.parquet

テストデータとして使用される系列で、上記と同じフィールドを含む。このファイル内の系列についてイベントの発生を予測する。

### train_events.csv

トレーニングセット内のシリーズの睡眠ログで、オンセットイベントとウェイクイベントを記録。
|name|説明|
|---|---|
|series_id | train_series.parquet内の加速度センサデータの各シリーズの一意な識別子。
|night | オンセットイベントとウェイクアップイベントのペアの列挙。各夜に発生するイベントのペアは最大1つ。|
|event | オンセットまたはウェイクアップのイベントのタイプ．|
|step and timestamp | 加速度センサーの系列における、イベントの発生時刻。|

### sample_submission.csv

正しいフォーマットのサンプル提出ファイル。詳細は評価ページを参照。

## 参考

|notebook|説明|
|---|---|
|[Summarizing our collective learnings over the past month](https://www.kaggle.com/competitions/optiver-trading-at-the-close/discussion/448920)|コンペ開始から１ヶ月時点での有用な情報をまとめている、基本的にはここをベースに描く情報をそれぞれ参照する|
|[[Optiver] Simple LGBM for beginner (Eng/日本語)](https://www.kaggle.com/code/junjitakeshima/optiver-simple-lgbm-for-beginner-eng)|すでに日本語訳のノートブック。シンプルなLGBMモデルの説明|
|||

## NOTE

### nb

|notebook|CV|PV|説明|
|---|---|---|---|
|kg-nb_zzz_001|||[[Optiver] Simple LGBM for beginner (Eng/日本語)](https://www.kaggle.com/code/junjitakeshima/optiver-simple-lgbm-for-beginner-eng)をコピーして作成|

### EDA

|notebook|説明|
|---|---|
|kg-nb_zzz_EDA_001|[🕐To Sleep or Not to Sleep? Deep EDA Dive ⚪⚫](https://www.kaggle.com/code/gvyshnya/to-sleep-or-not-to-sleep-deep-eda-dive)を日本語訳して内容把握|

## LOG

### 20231104

- リポジトリ作成
- [🕐To Sleep or Not to Sleep? Deep EDA Dive ⚪⚫](https://www.kaggle.com/code/gvyshnya/to-sleep-or-not-to-sleep-deep-eda-dive)を日本語訳して内容把握
  - kg-nb_zzz_EDA_001として作成

### 20231105

- kg-nb_zzz_EDA_001を参照
  - 欠損値がTrain_seriesは無し
  - 欠損値がtrain_evemtにはそこそこある（特にeventt

### 20231106

- [このノートブック](https://www.kaggle.com/code/tubotubo/cmi-submit)がリーダーボード破棄した模様
  - あまりにもSCOREがかけ離れているため、現実的なNotebookをまずは写経
- [Detect Sleep States - Inference](https://www.kaggle.com/code/itsuki9180/detect-sleep-states-inference)
  - NB上位の本コードを参照する
  - 「Interface」「DataPreparation」「Training」の三本立て
  - PyTorchでRNNを使用している？
  - 下記の通りそれぞれNote作成
  - ![NOTE_zzzs](https://github.com/fmoch/kaggle-Child-Mind-Institute_Detect-Sleep-States/assets/116940479/a1ac8a7b-d683-4ef4-bf7b-aaf98393d39d)

### 20231107

- 引き続きDataprepare内容確認中
- Pandasで実行しており、実行速度が遅い
  - 問題ないようであればPolarsに書き換えたい

### 20231108

- trainingパート確認完了
  - データ型を適切に選択肢データサイズを縮小
  - onsetとwakeupが同じnightにある場合のIDを抽出
  - ガウシアンをstartからendに適応->正規化用
- Trainパートに着手
  - RNNの基礎理論あrためて復習いるかも。。
  - 今回のモデルはGRUを用いている

### 20231009

- Prepareパートの実行時間が元の物の３倍？
  - ガウス関数の式がミスってた。修正して再度実行中
- trainパート作成中